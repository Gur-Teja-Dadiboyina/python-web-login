pipeline {
  agent any

  environment {
    DOCKERHUB_REPO = "yourusername/python-login"      // ✅ replace with your repo
    IMAGE_TAG = "${env.BUILD_NUMBER}"
    KUBE_CONFIG = credentials('kubeconfig-cred')      // Jenkins credential (Kubernetes config)
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build Docker Image') {
      steps {
        sh '''
          echo "Building Docker image..."
          docker build -t ${DOCKERHUB_REPO}:${IMAGE_TAG} -t ${DOCKERHUB_REPO}:latest .
        '''
      }
    }

    stage('Push to Docker Hub') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker-hub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          sh '''
            echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin
            docker push ${DOCKERHUB_REPO}:${IMAGE_TAG}
            docker push ${DOCKERHUB_REPO}:latest
            docker logout || true
          '''
        }
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        withCredentials([file(credentialsId: 'kubeconfig-cred', variable: 'KUBECONFIG')]) {
          sh '''
            echo "Deploying to Kubernetes cluster..."
            # Update image in the deployment file
            sed -i "s|yourusername/python-login:latest|${DOCKERHUB_REPO}:${IMAGE_TAG}|g" deployment.yaml
            
            # Apply both deployment and service
            kubectl apply -f deployment.yaml
            kubectl apply -f service.yaml
            
            # Verify rollout
            kubectl rollout status deployment/python-login-deployment
          '''
        }
      }
    }
  }

  post {
    success {
      echo "✅ Deployment successful!"
    }
    failure {
      echo "❌ Deployment failed — check logs!"
    }
  }
}
